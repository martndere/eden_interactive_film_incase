{% extends "eden/base_clip.html" %}
{% load static %}

{% block title %}{{ clip.name }}{% endblock %}

{% block content %}
  <h1>{{ clip.name }}</h1>

  <video id="clipC" width="640" controls>
    <source src="{{ clip.video.url }}" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <p>{{ clip.description }}</p>

  <!-- Choices (hidden by default) -->
  <div id="choices" style="display:none;">
    <h2>What do you want to investigate?</h2>
    <div class="choices">
      <button
        class="choice-link"
        id="choice-camera"
        hx-get="{% url 'clip_detail' 'clip_g' %}"
        hx-target="#main-content"
        hx-swap="innerHTML">
        One Camera Unsynched.
      </button>
      <button
        class="choice-link"
        id="choice-toxicology"
        hx-get="{% url 'clip_detail' 'clip_e' %}"
        hx-target="#main-content"
        hx-swap="innerHTML">
        Toxicology Report Available.
      </button>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
function setupClipC() {
  const video = document.getElementById('clipC');
  const choicesDiv = document.getElementById('choices');
  const choiceButtons = choicesDiv ? choicesDiv.querySelectorAll('.choice-link') : [];
  const IDLE_TIMEOUT = 10 * 1000; // 10 seconds
  const CHOICES_SHOW_TIME = 91; // 1:31 in seconds

  let choicesShown = false;
  let idleTimer = null;

  if (choicesDiv) choicesDiv.style.display = 'none';

  // Show choices at 1:31 (91s)
  video.addEventListener('timeupdate', () => {
    if (video.currentTime >= CHOICES_SHOW_TIME && !choicesShown) {
      if (choicesDiv) choicesDiv.style.display = 'block';
      choicesShown = true;

      // Start idle timer for auto-selecting "Toxicology report available" (second button)
      idleTimer = setTimeout(() => {
        const toxicologyBtn = document.getElementById('choice-toxicology');
        if (toxicologyBtn) {
          toxicologyBtn.click();
        }
      }, IDLE_TIMEOUT);
    }

    // If user rewinds before 1:31, hide choices and clear timer
    if (video.currentTime < CHOICES_SHOW_TIME && choicesShown) {
      if (choicesDiv) choicesDiv.style.display = 'none';
      choicesShown = false;
      if (idleTimer) {
        clearTimeout(idleTimer);
        idleTimer = null;
      }
    }
  });

  // If user clicks any choice, clear idle timer
  choiceButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      if (idleTimer) {
        clearTimeout(idleTimer);
        idleTimer = null;
      }
    });
  });
}

// Run on initial load
setupClipC();

// Run after htmx swaps (for AJAX navigation)
document.body.addEventListener('htmx:afterSwap', function(evt) {
  if (document.getElementById('clipC')) {
    setupClipC();
  }
});
</script>
{% endblock %}