{% extends "eden/base_clip.html" %}
{% load static %}

{% block title %}{{ clip.name }}{% endblock %}

{% block content %}
<div class="video-editor-container">
  <h1 class="main-title">{{ clip.name }}</h1>

  <div class="video-player">
    <video id="clipB" class="clip-video" controls>
      <source src="{{ clip.video.url }}" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <!-- News ticker below video player -->
  <div class="news-ticker-container" id="newsTicker">
    <div class="news-ticker">
      <span>
        BREAKING: Kenya launches Africaâ€™s largest green tech hub! | Nairobi traffic robots now powered by AI! | Kenyan animators win global awards for interactive storytelling!
      </span>
    </div>
  </div>
  <!-- End news ticker -->

  <audio id="voicePrompt">
    <source src="{% static 'audio/choose_case_file.mp3' %}" type="audio/mpeg">
  </audio>

  <!-- Character Choices -->
  <div id="choices" style="display: none;">
    <h2 class="subtitle">Who do you want to investigate?</h2>
    <div class="mini-choice-strip">
      {% for choice in choices %}
        <button class="mini-choice-link"
                hx-get="{% url 'clip_detail' choice.to_clip.slug %}"
                hx-target="#main-content"
                hx-swap="innerHTML">
          {% if choice.image %}
            <img src="{{ choice.image.url }}" alt="{{ choice.label }}" class="mini-choice-img">
          {% endif %}
        </button>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Fade out the ticker after 10 seconds
  setTimeout(function() {
    var ticker = document.getElementById('newsTicker');
    if (ticker) {
      ticker.classList.add('fade-out');
    }
  }, 10000);

  function setupClipB() {
    const video = document.getElementById('clipB');
    const voicePrompt = document.getElementById('voicePrompt');
    const choicesDiv = document.getElementById('choices');

    const CHOICES_SHOW_TIME = 5.0;
    let audioPlayed = false;
    let choicesShown = false;

    if (choicesDiv) choicesDiv.style.display = 'none';

    video.addEventListener('timeupdate', () => {
      const currentTime = video.currentTime;

      if (currentTime >= CHOICES_SHOW_TIME && !choicesShown) {
        if (choicesDiv) choicesDiv.style.display = 'block';
        video.pause();
        choicesShown = true;
        if (!audioPlayed) {
          voicePrompt.play();
          audioPlayed = true;
        }
      }

      if (currentTime < CHOICES_SHOW_TIME && (audioPlayed || choicesShown)) {
        voicePrompt.pause();
        voicePrompt.currentTime = 0;
        audioPlayed = false;
        if (choicesDiv) choicesDiv.style.display = 'none';
        choicesShown = false;
      }
    });
  }

  setupClipB();

  document.body.addEventListener('htmx:afterSwap', function () {
    if (document.getElementById('clipB')) {
      setupClipB();
    }
  });
</script>
{% endblock %}
