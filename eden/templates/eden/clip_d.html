{% extends "eden/base_clip.html" %}
{% load static %}

{% block title %}{{ clip.name }}{% endblock %}

{% block content %}
  <h1>{{ clip.name }}</h1>

  <video id="clipD" width="640" controls>
    <source src="{{ clip.video.url }}" type="video/mp4">
    Your browser does not support the video tag.
  </video>
  <p>{{ clip.description }}</p>

  <div id="choices" style="display:none; gap:2em; justify-content:center; margin-top:1em;">
    <button
      class="choice-link"
      id="choice-suspect-a"
      hx-get="{% url 'clip_detail' 'clip_f' %}"
      hx-target="#main-content"
      hx-swap="innerHTML">
      FOLLOW SUSPECT
    </button>
    <button
      class="choice-link"
      id="choice-suspect-b"
      hx-get="{% url 'clip_detail' 'clip_g' %}"
      hx-target="#main-content"
      hx-swap="innerHTML">
      FOLLOW SUSPECT B
    </button>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>
function setupClipD() {
  const video = document.getElementById('clipD');
  const choicesDiv = document.getElementById('choices');
  const suspectA = document.getElementById('choice-suspect-a');
  const suspectB = document.getElementById('choice-suspect-b');
  const CHOICES_SHOW_TIME = 13; // seconds
  const IDLE_TIMEOUT = 10 * 1000; // 10 seconds

  // Use properties on the video element to avoid redeclaration
  video._choicesShown = video._choicesShown || false;
  video._idleTimer = video._idleTimer || null;

  if (choicesDiv) choicesDiv.style.display = 'none';

  // Remove previous event listener if any
  if (video._clipDHandler) {
    video.removeEventListener('timeupdate', video._clipDHandler);
  }

  video._clipDHandler = function() {
    if (video.currentTime >= CHOICES_SHOW_TIME && !video._choicesShown) {
      if (choicesDiv) choicesDiv.style.display = 'flex';
      video.pause();
      video._choicesShown = true;

      // Start idle timer to auto-select FOLLOW SUSPECT (Clip F)
      video._idleTimer = setTimeout(() => {
        if (suspectA) suspectA.click();
      }, IDLE_TIMEOUT);
    }

    // If user rewinds before 0:13, hide choices and clear timer
    if (video.currentTime < CHOICES_SHOW_TIME && video._choicesShown) {
      if (choicesDiv) choicesDiv.style.display = 'none';
      video._choicesShown = false;
      if (video._idleTimer) {
        clearTimeout(video._idleTimer);
        video._idleTimer = null;
      }
    }
  };

  video.addEventListener('timeupdate', video._clipDHandler);

  // If user clicks any choice, clear idle timer
  [suspectA, suspectB].forEach(btn => {
    btn.addEventListener('click', () => {
      if (video._idleTimer) {
        clearTimeout(video._idleTimer);
        video._idleTimer = null;
      }
    });
  });
}

// Run on initial load
setupClipD();

// Run after htmx swaps (for AJAX navigation)
document.body.addEventListener('htmx:afterSwap', function(evt) {
  if (document.getElementById('clipD')) {
    setupClipD();
  }
});
</script>
{% endblock %}