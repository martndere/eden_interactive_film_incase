{% extends "eden/base_clip.html" %}
{% load static %}

{% block title %}{{ clip.name }}{% endblock %}

{% block content %}
  <div class="video-editor-container">
    <h1 class="main-title">üé• {{ clip.name }}</h1>

    <div class="video-player">
      <video id="clipA" class="clip-video" controls>
        <source src="{{ clip.video.url }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>

    {% if choices %}
      {% with next_clip=choices.0.to_clip.slug %}
        <button id="pressPlayBtn"
                hx-get="{% url 'clip_detail' next_clip %}"
                hx-target="#main-content"
                hx-swap="innerHTML"
                style="display:none;">
          ‚ñ∂Ô∏è Press Play
        </button>
      {% endwith %}
    {% endif %}

    <!-- News ticker below choice button -->
    <div class="news-ticker-container" id="newsTicker">
      <div class="news-ticker">
        <span>
          BREAKING: Kenya launches Africa‚Äôs largest green tech hub! | Nairobi traffic robots now powered by AI! | Kenyan animators win global awards for interactive storytelling!
        </span>
      </div>
    </div>
    <!-- End news ticker -->

  </div>

  <audio id="voicePrompt">
    <source src="{% static 'audio/my name is.mp3' %}" type="audio/mpeg">
  </audio>
{% endblock %}

{% block extra_scripts %}
<script>
  // Fade out the ticker after 10 seconds
  setTimeout(function() {
    var ticker = document.getElementById('newsTicker');
    if (ticker) {
      ticker.classList.add('fade-out');
    }
  }, 10000);

  const video = document.getElementById('clipA');
  const pressPlayBtn = document.getElementById('pressPlayBtn');
  const voicePrompt = document.getElementById('voicePrompt');

  const AUDIO_TRIGGER_TIME = 20.0;
  const BUTTON_SHOW_TIME = 30.0;
  const IDLE_TIMEOUT = 10000;

  let audioPlayed = false;
  let buttonShown = false;
  let idleTimer = null;

  if (pressPlayBtn) pressPlayBtn.style.display = 'none';

  video.addEventListener('timeupdate', () => {
    const currentTime = video.currentTime;

    if (currentTime >= AUDIO_TRIGGER_TIME && !audioPlayed) {
      voicePrompt.play();
      audioPlayed = true;
    }

    if (currentTime >= BUTTON_SHOW_TIME && !buttonShown) {
      if (pressPlayBtn) pressPlayBtn.style.display = 'block';
      video.pause();
      buttonShown = true;

      idleTimer = setTimeout(() => {
        window.location.reload();
      }, IDLE_TIMEOUT);
    }

    if (currentTime < AUDIO_TRIGGER_TIME) {
      voicePrompt.pause();
      voicePrompt.currentTime = 0;
      audioPlayed = false;
    }

    if (currentTime < BUTTON_SHOW_TIME && buttonShown) {
      if (pressPlayBtn) pressPlayBtn.style.display = 'none';
      buttonShown = false;
      if (idleTimer) {
        clearTimeout(idleTimer);
        idleTimer = null;
      }
    }
  });

  if (pressPlayBtn) {
    pressPlayBtn.addEventListener('click', () => {
      if (idleTimer) {
        clearTimeout(idleTimer);
        idleTimer = null;
      }
    });
  }
</script>
{% endblock %}
