<!-- templates/base_clip.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}EDEN Interactive Film{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  {% load static %}
  <link rel="stylesheet" href="{% static 'eden/css/style.css' %}">
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">

  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  {% block extra_head %}{% endblock %}
</head>

<body>
  <header>
    <nav>
      <a href="{% url 'eden:home' %}">Home</a>
      {% if user.is_authenticated %}
        <span>Welcome, {{ user.username }}!</span>
        <a href="{% url 'user:my_films' %}">My Films</a>
        <a href="{% url 'user:film_create' %}">Create Film</a>
        <a href="{% url 'user:profile' %}">Profile</a>
        <a href="{% url 'logout' %}">Logout</a>
      {% else %}
        <a href="{% url 'login' %}">Login</a>
        <a href="{% url 'register' %}">Register</a>
      {% endif %}
    </nav>
    {% block header %}
    <!-- Optional site header or logo -->
    {% endblock %}
  </header>

  <main id="main-content">
    {% block content %}{% endblock %}
  </main>

  <footer>
    {% block footer %}
    <!-- Optional footer -->
    {% endblock %}
  </footer>

  <script>
    function setupInteractiveClip(video) {
      if (!video || video.dataset.initialized) return;
      video.dataset.initialized = 'true';

      const choicesSelector = video.dataset.choicesSelector;
      const choicesDiv = choicesSelector ? document.querySelector(choicesSelector) : null;
      const showTime = parseFloat(video.dataset.choicesShowTime);
      const idleTimeout = parseInt(video.dataset.idleTimeoutMs, 10);
      const idleChoiceSelector = video.dataset.idleChoiceSelector;

      let choicesShown = false;
      let idleTimer = null;

      if (choicesDiv) choicesDiv.style.display = 'none';

      const timeUpdateHandler = () => {
        if (video.currentTime >= showTime && !choicesShown) {
          if (choicesDiv) choicesDiv.style.display = 'flex'; // Use flex for better centering
          video.pause();
          choicesShown = true;

          if (idleTimeout && idleChoiceSelector) {
            idleTimer = setTimeout(() => {
              const idleChoice = document.querySelector(idleChoiceSelector);
              if (idleChoice) idleChoice.click();
            }, idleTimeout);
          }
        }
      };

      video.addEventListener('timeupdate', timeUpdateHandler);

      if (choicesDiv) {
        choicesDiv.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => {
            if (idleTimer) clearTimeout(idleTimer);
          });
        });
      }
    }

    // Run on initial page load
    document.querySelectorAll('.clip-video').forEach(setupInteractiveClip);

    // Run after any HTMX swap
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      evt.detail.elt.querySelectorAll('.clip-video').forEach(setupInteractiveClip);
    });
  </script>
  {% block extra_scripts %}{% endblock %}
</body>
</html>