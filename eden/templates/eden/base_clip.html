<!-- templates/base_clip.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{% block title %}EDEN Interactive Film{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  {% load static %}
  <link rel="stylesheet" href="{% static 'eden/css/style.css' %}">
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">

  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  {% block extra_head %}{% endblock %}
</head>

<body>
  <header>
    <nav>
      <a href="{% url 'eden:home' %}">Home</a>
      {% if user.is_authenticated %}
        <span>Welcome, {{ user.username }}!</span>
        <a href="{% url 'user:my_films' %}">My Films</a>
        <a href="{% url 'user:film_create' %}">Create Film</a>
        <a href="{% url 'user:profile' %}">Profile</a>
        <a href="{% url 'logout' %}">Logout</a>
      {% else %}
        <a href="{% url 'login' %}">Login</a>
        <a href="{% url 'register' %}">Register</a>
      {% endif %}
    </nav>
    {% block header %}
    <!-- Optional site header or logo -->
    {% endblock %}
  </header>

  <main id="main-content">
    {% block content %}{% endblock %}
  </main>

  <footer>
    {% block footer %}
    <!-- Optional footer -->
    {% endblock %}
  </footer>

  <script>
    function setupInteractiveClip(video) {
      if (!video || video.dataset.initialized) return;
      video.dataset.initialized = 'true';

      const choicesSelector = video.dataset.choicesSelector;
      const choicesDiv = choicesSelector ? document.querySelector(choicesSelector) : null;
      const showTime = parseFloat(video.dataset.choicesShowTime);
      const idleTimeout = parseInt(video.dataset.idleTimeoutMs, 10);
      const idleChoiceSelector = video.dataset.idleChoiceSelector;
      const audioPlayTime = parseFloat(video.dataset.audioPlayTime);
      const audioPromptSelector = video.dataset.audioPromptSelector;
      const audioPrompt = audioPromptSelector ? document.querySelector(audioPromptSelector) : null;

      let choicesShown = false;
      let idleTimer = null;
      let audioPlayed = false;

      if (choicesDiv) choicesDiv.style.display = 'none';

      const timeUpdateHandler = () => {
        if (showTime && video.currentTime >= showTime && !choicesShown) {
          if (choicesDiv) {
            // Use flex for robust vertical and horizontal centering
            choicesDiv.style.display = 'flex';
            choicesDiv.style.flexDirection = 'column';
            choicesDiv.style.alignItems = 'center';
          }
          video.pause();
          choicesShown = true;

          if (audioPrompt && !audioPlayed) {
            audioPrompt.play();
            audioPlayed = true;
          }

          if (idleTimeout && idleChoiceSelector) {
            idleTimer = setTimeout(() => {
              const idleChoice = document.querySelector(idleChoiceSelector);
              if (idleChoice) idleChoice.click();
            }, idleTimeout);
          }
        }

        if (audioPlayTime && video.currentTime >= audioPlayTime && !audioPlayed) {
            if (audioPrompt) audioPrompt.play();
            audioPlayed = true;
        }
      };

      video.addEventListener('timeupdate', timeUpdateHandler);

      if (choicesDiv) {
        choicesDiv.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => {
            if (idleTimer) clearTimeout(idleTimer);
          });
        });
      }
    }

    function initializeContent(scope) {
      // Set up all interactive videos within the scope
      scope.querySelectorAll('.clip-video:not([data-initialized])').forEach(setupInteractiveClip);

      // Set up the news ticker fade-out if it exists in the scope
      const ticker = scope.querySelector('#newsTicker:not([data-initialized])');
      if (ticker) {
        ticker.dataset.initialized = 'true';
        setTimeout(() => ticker.classList.add('fade-out'), 10000);
      }
    }

    // Run on initial page load for the whole document
    document.addEventListener('DOMContentLoaded', () => initializeContent(document));
    // Run after any HTMX swap for the new content
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      initializeContent(evt.detail.elt);
    });
  </script>
  {% block extra_scripts %}{% endblock %}
</body>
</html>