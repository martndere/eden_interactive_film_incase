{% extends "eden/base_clip.html" %}
{% load static %}

{% block title %}{{ clip.name }}{% endblock %}

{% block content %}
  <div class="video-editor-container">
    <h1 class="main-title">{{ clip.name }}</h1>

    <div class="video-player">
      <video id="clipG" class="clip-video" controls>
        <source src="{{ clip.video.url }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>

            <!-- News ticker below video player -->
  <div class="news-ticker-container" id="newsTicker">
    <div class="news-ticker">
      <span>
        BREAKING: Kenya launches Africaâ€™s largest green tech hub! | Nairobi traffic robots now powered by AI! | Kenyan animators win global awards for interactive storytelling!
      </span>
    </div>
  </div>
  <!-- End news ticker -->

    <p class="subtitle">{{ clip.description }}</p>

    <div id="choices" style="display:none; gap:2em; justify-content:center; margin-top:1em;" class="choices">
      <button
        class="choice-link"
        id="choice-crime"
        hx-get="{% url 'clip_detail' 'clip_h' %}"
        hx-target="#main-content"
        hx-swap="innerHTML">
        VIEW CRIME SCENE
      </button>
      <button
        class="choice-link"
        id="choice-more"
        hx-get="{% url 'clip_detail' 'clip_f' %}"
        hx-target="#main-content"
        hx-swap="innerHTML">
        VIEW MORE EVIDENCE
      </button>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
<script>

 // Fade out the ticker after 10 seconds
  setTimeout(function() {
    var ticker = document.getElementById('newsTicker');
    if (ticker) {
      ticker.classList.add('fade-out');
    }
  }, 10000);

function setupClipG() {
  const video = document.getElementById('clipG');
  const choicesDiv = document.getElementById('choices');
  const crimeBtn = document.getElementById('choice-crime');
  const moreBtn = document.getElementById('choice-more');
  const CHOICES_SHOW_TIME = 40;
  const IDLE_TIMEOUT = 10000;

  let choicesShown = false;
  let idleTimer = null;

  if (choicesDiv) choicesDiv.style.display = 'none';

  video.addEventListener('timeupdate', () => {
    if (video.currentTime >= CHOICES_SHOW_TIME && !choicesShown) {
      if (choicesDiv) choicesDiv.style.display = 'flex';
      video.pause();
      choicesShown = true;

      idleTimer = setTimeout(() => {
        if (moreBtn) {
          moreBtn.click();
        }
      }, IDLE_TIMEOUT);
    }

    if (video.currentTime < CHOICES_SHOW_TIME && choicesShown) {
      if (choicesDiv) choicesDiv.style.display = 'none';
      choicesShown = false;
      if (idleTimer) {
        clearTimeout(idleTimer);
        idleTimer = null;
      }
    }
  });

  [crimeBtn, moreBtn].forEach(btn => {
    btn.addEventListener('click', () => {
      if (idleTimer) {
        clearTimeout(idleTimer);
        idleTimer = null;
      }
    });
  });
}

if (!window._clipGSetup) {
  setupClipG();
  window._clipGSetup = true;
}

document.body.addEventListener('htmx:afterSwap', function(evt) {
  if (document.getElementById('clipG')) {
    setupClipG();
  }
});
</script>
{% endblock %}
